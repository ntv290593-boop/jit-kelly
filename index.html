<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JIT Terminal V6 (Fix NAV) | Vi·ªát BOHO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        .glass-card { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255,255,255,0.05); }
        input { background: #0f172a; border: 1px solid #334155; border-radius: 4px; padding: 6px 12px; color: white; width: 100%; font-size: 13px; outline: none; transition: border-color 0.2s; }
        input:focus { border-color: #0ea5e9; }
        .label-xs { font-size: 9px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .tab-btn { @apply flex-1 py-3 text-xs font-bold uppercase text-slate-500 border-b-2 border-transparent transition-all cursor-pointer; }
        .tab-btn.active { @apply text-sky-400 border-sky-400 bg-slate-900/50; }
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: flex; flex-direction: column; }
        .text-up { color: #34d399; } .text-down { color: #f87171; } .text-ref { color: #fbbf24; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <nav class="h-12 border-b border-slate-800 flex justify-between items-center px-4 bg-[#0b1121]">
        <div class="flex items-center gap-2">
            <span class="text-xl">üìä</span>
            <h1 class="font-black text-sky-400 text-sm tracking-widest">JIT TERMINAL <span class="text-white opacity-50 font-light bg-slate-700 px-1 rounded">V6 NAV FIX</span></h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="updatePrices()" class="bg-purple-700 hover:bg-purple-600 text-white text-[10px] font-bold px-3 py-1.5 rounded flex items-center gap-2 transition animate-pulse">
                üé≤ SIMULATE PRICE
            </button>
            <div class="flex items-center gap-2 border-l border-slate-700 pl-3">
                <span class="text-[10px] text-slate-500 font-bold">NAV (VND):</span>
                <input type="text" id="totalNAV" value="1,000,000,000" class="bg-transparent border-none p-0 text-right font-bold text-yellow-500 w-32 text-sm focus:ring-0" oninput="formatNAV(this)" onchange="saveConfig()">
            </div>
        </div>
    </nav>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        <div class="flex-[2] bg-black border-r border-slate-800 relative h-full hidden md:block" id="chart-container">
            <div class="tradingview-widget-container" style="height:100%;width:100%">
              <div id="tradingview_b7f5c" style="height:100%;width:100%"></div>
              <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
              <script type="text/javascript">
              new TradingView.widget({
              "autosize": true, "symbol": "HOSE:HPG", "interval": "D", "timezone": "Asia/Ho_Chi_Minh", "theme": "dark", "style": "1", "locale": "vi_VN", "enable_publishing": false, "allow_symbol_change": true, "container_id": "tradingview_b7f5c"
              });
              </script>
            </div>
        </div>

        <div class="w-full md:w-[420px] flex flex-col bg-[#0f172a] h-full shadow-xl z-10 border-l border-slate-800">
            <div class="flex border-b border-slate-800 bg-[#020617]">
                <button onclick="switchTab('hunter')" id="tab-hunter" class="tab-btn active">üî≠ Hunter</button>
                <button onclick="switchTab('watchlist')" id="tab-watchlist" class="tab-btn">üìã Watchlist</button>
                <button onclick="switchTab('portfolio')" id="tab-portfolio" class="tab-btn">üíº Portfolio</button>
            </div>

            <div id="view-hunter" class="tab-content active p-5 space-y-4 overflow-y-auto">
                <div class="bg-slate-800/40 p-4 rounded border border-slate-700">
                    <h3 class="text-sky-400 font-bold text-sm mb-3 uppercase tracking-wider">Nh·∫≠p Setup JIT</h3>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="label-xs">M√£ CK</label><input type="text" id="symbol" placeholder="VD: HPG" class="uppercase font-bold tracking-wider"></div>
                            <div><label class="label-xs">Win Rate %</label><input type="number" id="winRate" value="60"></div>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div><label class="label-xs text-slate-400">Entry</label><input type="number" id="entry" step="0.05" placeholder="28.0"></div>
                            <div><label class="label-xs text-emerald-400">Target</label><input type="number" id="target" step="0.05" placeholder="32.0"></div>
                            <div><label class="label-xs text-rose-400">Stoploss</label><input type="number" id="stoploss" step="0.05" placeholder="26.5"></div>
                        </div>
                    </div>
                    
                    <button onclick="addToWatchlist()" class="w-full mt-4 bg-gradient-to-r from-sky-700 to-blue-700 hover:from-sky-600 text-white font-bold py-3 rounded shadow-lg text-xs uppercase transform active:scale-95 transition">
                        + Th√™m v√†o Watchlist
                    </button>
                </div>
                <div class="text-[10px] text-slate-500 italic text-center px-4">
                    *L∆∞u √Ω: Nh·∫≠p gi√° ƒë∆°n v·ªã ngh√¨n ƒë·ªìng (VD: 28.5 t·ª©c l√† 28,500ƒë)
                </div>
            </div>

            <div id="view-watchlist" class="tab-content p-4 overflow-y-auto space-y-3 bg-[#0b1121]">
                <div id="watchlist-container" class="space-y-3 pb-10"></div>
            </div>

            <div id="view-portfolio" class="tab-content p-4 overflow-y-auto space-y-3 bg-[#0b1121]">
                 <div class="flex justify-between px-1 border-b border-slate-800 pb-2 mb-2">
                     <span class="label-xs text-slate-400">T·ªïng PnL (Gi·∫£ l·∫≠p)</span>
                     <span id="total-pnl" class="text-sm font-bold text-white">---</span>
                 </div>
                <div id="portfolio-container" class="space-y-3 pb-10"></div>
            </div>
        </div>
    </main>

    <script>
        let mockMarketData = {}; 
        let watchlist = JSON.parse(localStorage.getItem('jitWatchlist')) || [];
        let portfolio = JSON.parse(localStorage.getItem('jitPortfolio')) || [];

        // --- 1. X·ª¨ L√ù NAV C√ì D·∫§U PH·∫®Y ---
        // Khi load trang
        if(localStorage.getItem('jitNAV')) {
            document.getElementById('totalNAV').value = localStorage.getItem('jitNAV');
        }
        
        // H√†m format khi nh·∫≠p li·ªáu (1000000 -> 1,000,000)
        function formatNAV(input) {
            // X√≥a h·∫øt k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
            let value = input.value.replace(/\D/g, "");
            // Format l·∫°i c√≥ d·∫•u ph·∫©y
            input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // H√†m l·∫•y gi√° tr·ªã NAV th√¥ (s·ªë) ƒë·ªÉ t√≠nh to√°n
        function getRawNAV() {
            const val = document.getElementById('totalNAV').value;
            // X√≥a d·∫•u ph·∫©y ƒë·ªÉ ra s·ªë nguy√™n (1,000,000 -> 1000000)
            return parseFloat(val.replace(/,/g, '')) || 0;
        }

        simulatePrices();

        // --- CORE LOGIC (ƒê√É FIX) ---
        function updatePrices() { simulatePrices(); renderWatchlist(); renderPortfolio(); }
        
        function simulatePrices() {
            const allItems = [...watchlist, ...portfolio];
            allItems.forEach(item => {
                const randomChange = (Math.random() * 0.1) - 0.05; 
                const fakePrice = item.ent * (1 + randomChange);
                mockMarketData[item.sym] = {
                    price: parseFloat(fakePrice.toFixed(2)),
                    change: (randomChange * 100).toFixed(2),
                    color: fakePrice > item.ent ? 'text-up' : (fakePrice < item.ent ? 'text-down' : 'text-ref')
                };
            });
        }

        function calculateJIT(item) {
            // L·∫•y NAV chu·∫©n t·ª´ h√†m getRawNAV (quan tr·ªçng!)
            const nav = getRawNAV(); 

            const reward = item.tg - item.ent;
            const risk = item.ent - item.sl;
            
            // Logic 1% Risk Rule
            const riskAmt = nav * 0.01; // S·ªë ti·ªÅn ch·∫•p nh·∫≠n m·∫•t (1% NAV)
            const lossPerShare = risk * 1000; // L·ªó tr√™n 1 c·ªï phi·∫øu (VND)
            
            let qRisk = 0;
            if(lossPerShare > 0) {
                // C√¥ng th·ª©c: (S·ªë ti·ªÅn r·ªßi ro / L·ªó 1 c·ªï) -> L√†m tr√≤n xu·ªëng l√¥ 100
                qRisk = Math.floor((riskAmt / lossPerShare) / 100) * 100;
            }

            // Logic Cash Constraint (Kh√¥ng mua qu√° ti·ªÅn m·∫∑t)
            const pricePerShare = item.ent * 1000;
            const qCash = Math.floor((nav / pricePerShare) / 100) * 100;

            // An to√†n: L·∫•y s·ªë nh·ªè nh·∫•t
            const qSafe = Math.min(qRisk, qCash);
            
            // T√≠nh t·ªïng gi√° tr·ªã mua ƒë·ªÉ hi·ªÉn th·ªã % NAV
            const totalValue = qSafe * pricePerShare;
            const percentNAV = nav > 0 ? (totalValue / nav) * 100 : 0;

            return { qSafe, totalValue, percentNAV };
        }

        // --- RENDERERS ---
        function renderWatchlist() {
            const container = document.getElementById('watchlist-container');
            if(watchlist.length === 0) { container.innerHTML = `<div class="text-center text-slate-600 text-xs mt-8">Danh s√°ch tr·ªëng.</div>`; return; }

            container.innerHTML = watchlist.map(i => {
                const res = calculateJIT(i);
                const mkt = mockMarketData[i.sym] || { price: i.ent, change: 0, color: 'text-white' };
                const isBuyZone = mkt.price > 0 && mkt.price <= i.ent;
                
                return `
                <div class="glass-card p-3 rounded border-l-4 ${isBuyZone ? 'border-emerald-500 bg-emerald-900/20' : 'border-yellow-500 bg-[#1e293b]'} relative">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-black text-white text-lg">${i.sym}</span>
                            <span class="text-[10px] text-slate-400 block">Entry: <b>${i.ent}</b> | SL: <b class="text-red-400">${i.sl}</b></span>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${mkt.color}">${mkt.price}</div>
                            <div class="text-[9px] ${mkt.change >= 0 ? 'text-emerald-400' : 'text-red-400'}">${mkt.change}%</div>
                        </div>
                    </div>
                    
                    ${isBuyZone ? `<div class="my-2 text-center text-[10px] font-bold text-emerald-400 animate-pulse bg-emerald-900/50 rounded py-1">‚ö° GI√Å V·ªÄ V√ôNG MUA! ‚ö°</div>` : ''}

                    <div class="mt-2 border-t border-slate-700/50 pt-2 grid grid-cols-2 gap-2">
                        <div>
                            <span class="block text-[9px] text-slate-400">KL Mua (1% Risk)</span>
                            <span class="font-bold text-yellow-400 text-sm">${res.qSafe.toLocaleString()} cp</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-[9px] text-slate-400">Gi√° tr·ªã / %NAV</span>
                            <span class="font-bold text-sky-400 text-xs">${(res.totalValue/1000000).toLocaleString()} Tr (${res.percentNAV.toFixed(1)}%)</span>
                        </div>
                    </div>
                     <div class="mt-2 flex gap-2">
                             <button onclick="moveToPortfolio(${i.id})" class="flex-1 bg-sky-700 hover:bg-sky-600 text-white text-[10px] py-1.5 px-3 rounded font-bold shadow-lg">ƒê√É KH·ªöP</button>
                             <button onclick="deleteItem('w', ${i.id})" class="bg-slate-800 hover:bg-red-900 text-slate-400 py-1.5 px-2.5 rounded">‚úï</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderPortfolio() {
            const container = document.getElementById('portfolio-container');
            let totalProfit = 0;

            if(portfolio.length === 0) { container.innerHTML = `<div class="text-center text-slate-600 text-xs mt-8">K√©t s·∫Øt r·ªóng.</div>`; document.getElementById('total-pnl').innerText = "0.00 Tr"; return; }

            container.innerHTML = portfolio.map(i => {
                const res = calculateJIT(i);
                const mkt = mockMarketData[i.sym] || { price: i.ent, change: 0, color: 'text-slate-300' };
                const currentProfit = (mkt.price - i.ent) * 1000 * res.qSafe;
                totalProfit += currentProfit;
                
                return `
                <div class="glass-card p-3 rounded bg-[#131c31] border-l-2 ${currentProfit >= 0 ? 'border-emerald-500' : 'border-rose-500'}">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-black text-white text-lg">${i.sym}</span>
                        <div class="text-right">
                            <span class="text-sm font-bold ${currentProfit >= 0 ? 'text-emerald-400' : 'text-rose-400'}">
                                ${currentProfit > 0 ? '+' : ''}${(currentProfit/1000000).toFixed(2)} Tr
                            </span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-[10px] text-slate-400 bg-black/20 p-2 rounded">
                        <span>Gi√°: <b class="${mkt.color}">${mkt.price}</b></span>
                        <span>KL: <b>${res.qSafe.toLocaleString()}</b></span>
                        <span>%NAV: <b class="text-sky-400">${res.percentNAV.toFixed(1)}%</b></span>
                    </div>
                    <div class="text-right mt-2">
                         <button onclick="deleteItem('p', ${i.id})" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded text-slate-300">T·∫•t to√°n</button>
                    </div>
                </div>`;
            }).join('');
            const pnlEl = document.getElementById('total-pnl');
            pnlEl.innerText = `${totalProfit > 0 ? '+' : ''}${(totalProfit/1000000).toFixed(2)} Tr`;
            pnlEl.className = `text-sm font-bold ${totalProfit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
        }

        // --- HELPER FUNC ---
        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${t}`).classList.add('active');
            document.getElementById(`tab-${t}`).classList.add('active');
        }
        function addToWatchlist() {
            const sym = document.getElementById('symbol').value.toUpperCase();
            const ent = parseFloat(document.getElementById('entry').value);
            const tg = parseFloat(document.getElementById('target').value);
            const sl = parseFloat(document.getElementById('stoploss').value);
            if(!sym || isNaN(ent) || isNaN(sl)) return alert("Nh·∫≠p thi·∫øu th√¥ng s·ªë r·ªìi Vi·ªát ∆°i!");
            
            watchlist.unshift({ id: Date.now(), sym, ent, tg, sl });
            saveConfig(); switchTab('watchlist'); simulatePrices();
        }
        function moveToPortfolio(id) {
            const item = watchlist.find(i => i.id === id);
            if(item && confirm(`X√°c nh·∫≠n kh·ªõp l·ªánh ${item.sym}?`)) {
                watchlist = watchlist.filter(i => i.id !== id);
                portfolio.unshift(item);
                saveConfig(); switchTab('portfolio'); simulatePrices();
            }
        }
        function deleteItem(type, id) {
            if(confirm('X√≥a m√£ n√†y?')) {
                if(type === 'w') watchlist = watchlist.filter(i => i.id !== id);
                else portfolio = portfolio.filter(i => i.id !== id);
                saveConfig();
            }
        }
        function saveConfig() {
            localStorage.setItem('jitWatchlist', JSON.stringify(watchlist));
            localStorage.setItem('jitPortfolio', JSON.stringify(portfolio));
            localStorage.setItem('jitNAV', document.getElementById('totalNAV').value);
            renderWatchlist(); renderPortfolio();
        }
    </script>
</body>
</html>

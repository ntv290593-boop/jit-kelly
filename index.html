<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JIT Terminal Auto | Vi·ªát BOHO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        .glass-card { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255,255,255,0.05); }
        input { background: #0f172a; border: 1px solid #334155; border-radius: 4px; padding: 6px 12px; color: white; width: 100%; font-size: 13px; outline: none; }
        input:focus { border-color: #0ea5e9; }
        .label-xs { font-size: 9px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .tab-btn { @apply flex-1 py-3 text-xs font-bold uppercase text-slate-500 border-b-2 border-transparent transition-all cursor-pointer; }
        .tab-btn.active { @apply text-sky-400 border-sky-400 bg-slate-900/50; }
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: flex; flex-direction: column; }
        .price-up { color: #34d399; }
        .price-down { color: #f87171; }
        .price-ref { color: #fbbf24; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <nav class="h-12 border-b border-slate-800 flex justify-between items-center px-4 bg-[#0b1121]">
        <div class="flex items-center gap-2">
            <span class="text-xl animate-pulse">üî¥</span>
            <h1 class="font-black text-sky-400 text-sm tracking-widest">JIT LIVE <span class="text-white opacity-50 font-light">V5.0</span></h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="updatePrices()" class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold px-3 py-1 rounded flex items-center gap-1">
                üîÑ C·∫¨P NH·∫¨T GI√Å
            </button>
            <div class="flex items-center gap-1">
                <span class="text-[10px] text-slate-500">NAV:</span>
                <input type="number" id="totalNAV" value="1000000000" class="bg-transparent border-none p-0 text-right font-bold text-yellow-500 w-24 text-sm focus:ring-0" onchange="saveConfig()">
            </div>
        </div>
    </nav>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        <div class="flex-[2] bg-black border-r border-slate-800 relative h-full hidden md:block">
            <div id="tradingview_widget" class="h-full w-full"></div>
             <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
            <script type="text/javascript">
            new TradingView.widget({ "autosize": true, "symbol": "HOSE:HPG", "interval": "D", "timezone": "Asia/Ho_Chi_Minh", "theme": "dark", "style": "1", "locale": "vi", "enable_publishing": false, "container_id": "tradingview_widget" });
            </script>
        </div>

        <div class="w-full md:w-[420px] flex flex-col bg-[#0f172a] h-full shadow-xl z-10 border-l border-slate-800">
            <div class="flex border-b border-slate-800 bg-[#020617]">
                <button onclick="switchTab('hunter')" id="tab-hunter" class="tab-btn active">üî≠ Hunter</button>
                <button onclick="switchTab('watchlist')" id="tab-watchlist" class="tab-btn">üìã Watchlist</button>
                <button onclick="switchTab('portfolio')" id="tab-portfolio" class="tab-btn">üíº Portfolio</button>
            </div>

            <div id="view-hunter" class="tab-content active p-5 space-y-4 overflow-y-auto">
                <div class="bg-slate-800/50 p-4 rounded border border-slate-700">
                    <h3 class="text-sky-400 font-bold text-sm mb-3">T√çNH TO√ÅN V·ªä TH·∫æ</h3>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="label-xs">M√£ CK</label><input type="text" id="symbol" placeholder="VD: HPG" class="uppercase font-bold"></div>
                            <div><label class="label-xs">Win Rate %</label><input type="number" id="winRate" value="60"></div>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div><label class="label-xs text-slate-400">Entry</label><input type="number" id="entry" step="0.1"></div>
                            <div><label class="label-xs text-emerald-400">Target</label><input type="number" id="target" step="0.1"></div>
                            <div><label class="label-xs text-rose-400">Stoploss</label><input type="number" id="stoploss" step="0.1"></div>
                        </div>
                    </div>
                    <button onclick="addToWatchlist()" class="w-full mt-4 bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 rounded shadow-lg text-xs uppercase">
                        + Theo d√µi
                    </button>
                </div>
            </div>

            <div id="view-watchlist" class="tab-content p-4 overflow-y-auto space-y-3 bg-[#0b1121]">
                <div id="watchlist-container" class="space-y-3 pb-10"></div>
            </div>

            <div id="view-portfolio" class="tab-content p-4 overflow-y-auto space-y-3 bg-[#0b1121]">
                 <div class="flex justify-between px-1"><span class="label-xs text-slate-400">L√£i/L·ªó t·∫°m t√≠nh</span><span id="total-pnl" class="text-xs font-bold text-white">---</span></div>
                <div id="portfolio-container" class="space-y-3 pb-10"></div>
            </div>
        </div>
    </main>

    <script>
        // --- ‚ö†Ô∏è D√ÅN URL APPS SCRIPT C·ª¶A VI·ªÜT V√ÄO ƒê√ÇY ---
        const API_URL = https://script.google.com/macros/s/AKfycbwzQambKv1QOa8CdPRbBvbp7JSwCtgiZQuKN0ZRnKEK8Z_7SbuuEyQAX9cbVgRmhAc2fA/exec; 
        // V√≠ d·ª•: https://script.google.com/macros/s/AKfycbx.../exec

        let watchlist = JSON.parse(localStorage.getItem('jitWatchlist')) || [];
        let portfolio = JSON.parse(localStorage.getItem('jitPortfolio')) || [];
        let marketData = {}; // Ch·ª©a gi√° realtime

        // INIT
        if(localStorage.getItem('jitNAV')) document.getElementById('totalNAV').value = localStorage.getItem('jitNAV');
        renderWatchlist();
        renderPortfolio();
        updatePrices(); // G·ªçi gi√° ngay khi m·ªü

        // --- CORE FUNCTIONS ---
        async function updatePrices() {
            if(API_URL.includes("D√ÅN_LINK")) {
                console.log("Ch∆∞a d√°n Link API!"); 
                return;
            }

            // L·∫•y t·∫•t c·∫£ m√£ t·ª´ Watchlist v√† Portfolio
            const symbols = [...new Set([...watchlist.map(i=>i.sym), ...portfolio.map(i=>i.sym)])].join(',');
            if(!symbols) return;

            document.body.style.cursor = 'wait';
            try {
                // G·ªçi t·ªõi Apps Script
                const res = await fetch(`${API_URL}?symbols=${symbols}`);
                const data = await res.json();
                
                // data tr·∫£ v·ªÅ t·ª´ TCBS d·∫°ng m·∫£ng
                if(data && data.data) {
                    data.data.forEach(stock => {
                        marketData[stock.ticker] = {
                            price: stock.price, // Gi√° kh·ªõp
                            change: stock.changePercent, // % TƒÉng gi·∫£m
                            color: stock.price > stock.refPrice ? 'price-up' : (stock.price < stock.refPrice ? 'price-down' : 'price-ref')
                        };
                    });
                    renderWatchlist();
                    renderPortfolio();
                }
            } catch(e) { console.error(e); }
            document.body.style.cursor = 'default';
        }

        function calculateJIT(nav, item) {
            const reward = item.tg - item.ent;
            const risk = item.ent - item.sl;
            const b = reward / risk;
            let k = (item.p * (b + 1) - 1) / b;
            k = k > 0 ? k : 0;
            
            const riskAmt = nav * 0.01;
            const qRisk = Math.floor((riskAmt / (risk * 1000)) / 100) * 100;
            const qCash = Math.floor((nav / (item.ent * 1000))/100) * 100;
            
            return { qSafe: Math.min(qRisk, qCash) };
        }

        // --- RENDERERS ---
        function renderWatchlist() {
            const nav = parseFloat(document.getElementById('totalNAV').value);
            const container = document.getElementById('watchlist-container');
            
            container.innerHTML = watchlist.map(i => {
                const res = calculateJIT(nav, i);
                const mkt = marketData[i.sym] || { price: 0, change: 0, color: 'text-white' };
                // Logic c·∫£nh b√°o: N·∫øu gi√° th·ªã tr∆∞·ªùng <= Entry (ƒë√£ v·ªÅ v√πng mua) -> Highlight
                const isBuyZone = mkt.price > 0 && mkt.price <= i.ent;
                const bgClass = isBuyZone ? 'bg-emerald-900/30 border-emerald-500' : 'bg-[#1e293b] border-slate-700';

                return `
                <div class="glass-card p-3 rounded border-l-4 ${isBuyZone ? 'border-emerald-500' : 'border-yellow-500'} ${bgClass} relative">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-black text-white text-lg">${i.sym}</span>
                            <span class="text-[10px] text-slate-500 block">Entry: ${i.ent}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${mkt.color}">${mkt.price > 0 ? mkt.price : '---'}</div>
                            <div class="text-[9px] ${mkt.change >= 0 ? 'text-emerald-400' : 'text-red-400'}">${mkt.change}%</div>
                        </div>
                    </div>
                    <div class="mt-2 flex justify-between items-end">
                        <div>
                            <span class="block text-[9px] text-slate-400">KL Khuy·∫øn ngh·ªã</span>
                            <span class="font-bold text-yellow-400 text-sm">${res.qSafe.toLocaleString()}</span>
                        </div>
                        ${isBuyZone ? `<span class="animate-pulse text-[10px] bg-emerald-600 text-white px-2 py-1 rounded font-bold">M√öC NGAY!</span>` : ''}
                    </div>
                    <div class="mt-2 pt-2 border-t border-slate-700/50 flex gap-2">
                         <button onclick="moveToPortfolio(${i.id})" class="flex-1 bg-sky-700 hover:bg-sky-600 text-white text-[10px] py-1.5 rounded">ƒê√É KH·ªöP</button>
                         <button onclick="deleteItem('w', ${i.id})" class="px-3 bg-slate-800 text-slate-400 rounded text-[10px]">‚úï</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderPortfolio() {
            const nav = parseFloat(document.getElementById('totalNAV').value);
            const container = document.getElementById('portfolio-container');
            let totalProfit = 0;

            container.innerHTML = portfolio.map(i => {
                const res = calculateJIT(nav, i);
                const mkt = marketData[i.sym] || { price: i.ent, change: 0, color: 'text-white' }; // N·∫øu ch∆∞a c√≥ gi√° th√¨ l·∫•y gi√° v·ªën
                
                // T√≠nh l√£i l·ªó t·∫°m t√≠nh (Gi·∫£ s·ª≠ ƒë√£ mua theo kh·ªëi l∆∞·ª£ng qSafe)
                // L√£i = (Gi√° hi·ªán t·∫°i - Gi√° v·ªën) * Kh·ªëi l∆∞·ª£ng
                const currentProfit = (mkt.price - i.ent) * 1000 * res.qSafe;
                totalProfit += currentProfit;

                return `
                <div class="glass-card p-3 rounded bg-[#131c31] border-l-2 ${currentProfit >= 0 ? 'border-emerald-500' : 'border-rose-500'}">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-black text-white text-lg">${i.sym}</span>
                        <div class="text-right">
                            <span class="text-sm font-bold ${currentProfit >= 0 ? 'text-emerald-400' : 'text-rose-400'}">
                                ${currentProfit > 0 ? '+' : ''}${(currentProfit/1000000).toFixed(2)} Tr
                            </span>
                        </div>
                    </div>
                    <div class="flex justify-between text-[10px] text-slate-400 bg-black/20 p-2 rounded">
                        <span>Gi√° v·ªën: <b>${i.ent}</b></span>
                        <span>Th·ªã tr∆∞·ªùng: <b class="${mkt.color}">${mkt.price}</b></span>
                    </div>
                    <div class="text-right mt-2">
                         <button onclick="deleteItem('p', ${i.id})" class="text-[10px] text-slate-500 hover:text-red-400">T·∫•t to√°n</button>
                    </div>
                </div>`;
            }).join('');

            const pnlEl = document.getElementById('total-pnl');
            pnlEl.innerText = `${totalProfit > 0 ? '+' : ''}${(totalProfit/1000000).toFixed(2)} Tri·ªáu`;
            pnlEl.className = `text-sm font-bold ${totalProfit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
        }

        // --- HELPER FUNC ---
        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${t}`).classList.add('active');
            document.getElementById(`tab-${t}`).classList.add('active');
        }
        function addToWatchlist() {
            const sym = document.getElementById('symbol').value.toUpperCase();
            const p = document.getElementById('winRate').value / 100;
            const ent = parseFloat(document.getElementById('entry').value);
            const tg = parseFloat(document.getElementById('target').value);
            const sl = parseFloat(document.getElementById('stoploss').value);
            if(!sym || !ent) return;
            watchlist.unshift({ id: Date.now(), sym, p, ent, tg, sl });
            saveConfig(); switchTab('watchlist'); updatePrices();
        }
        function moveToPortfolio(id) {
            const item = watchlist.find(i => i.id === id);
            if(item && confirm(`X√°c nh·∫≠n kh·ªõp l·ªánh ${item.sym}?`)) {
                watchlist = watchlist.filter(i => i.id !== id);
                portfolio.unshift(item);
                saveConfig(); switchTab('portfolio'); updatePrices();
            }
        }
        function deleteItem(type, id) {
            if(confirm('X√≥a m√£ n√†y?')) {
                if(type === 'w') watchlist = watchlist.filter(i => i.id !== id);
                else portfolio = portfolio.filter(i => i.id !== id);
                saveConfig();
            }
        }
        function saveConfig() {
            localStorage.setItem('jitWatchlist', JSON.stringify(watchlist));
            localStorage.setItem('jitPortfolio', JSON.stringify(portfolio));
            localStorage.setItem('jitNAV', document.getElementById('totalNAV').value);
            renderWatchlist(); renderPortfolio();
        }
    </script>
</body>
</html>

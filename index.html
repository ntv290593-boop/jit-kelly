<script>
        // --- DATA STORE ---
        let watchlist = JSON.parse(localStorage.getItem('jitWatchlist')) || [];
        let portfolio = JSON.parse(localStorage.getItem('jitPortfolio')) || [];
        let history = JSON.parse(localStorage.getItem('jitHistory')) || [];
        
        // QU·∫¢N L√ù V·ªêN CHU·∫®N K·∫æ TO√ÅN
        // 1. Ti·ªÅn m·∫∑t th·ª±c c√≥ (Lu√¥n >= 0)
        let cashBalance = parseFloat(localStorage.getItem('jitCash')) || 1000000000;
        // 2. D∆∞ n·ª£ Margin (Lu√¥n >= 0)
        let marginDebt = parseFloat(localStorage.getItem('jitDebt')) || 0;
        
        let mockMarketData = {}; 
        let currentTx = null;
        let currentNAV = 0; // Bi·∫øn to√†n c·ª•c l∆∞u NAV ƒë·ªÉ t√≠nh JIT

        // --- INIT ---
        simulatePrices(); // Ch·∫°y gi·∫£ l·∫≠p gi√° ƒë·ªÉ c√≥ d·ªØ li·ªáu ban ƒë·∫ßu
        updateDashboard(); // T√≠nh to√°n l·∫°i to√†n b·ªô s·ªë li·ªáu

        // --- UTILS ---
        function formatNumber(num) { 
            if (num === undefined || num === null || isNaN(num)) return '0';
            // X·ª≠ l√Ω s·ªë √¢m hi·ªÉn th·ªã d·∫•u -
            return num.toLocaleString('en-US', {maximumFractionDigits: 0}); 
        }
        function parseNumber(str) { return parseFloat(String(str).replace(/,/g, '')) || 0; }
        function formatCurrencyInput(input) {
            let val = input.value.replace(/\D/g, "");
            input.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            if(document.getElementById('txModal').style.display === 'flex') updateTxCalc();
        }
        
        // --- CORE LOGIC: DASHBOARD & NAV ---
        function updateDashboard() {
            // 1. T√≠nh t·ªïng gi√° tr·ªã th·ªã tr∆∞·ªùng c·ªßa C·ªï phi·∫øu (Market Value)
            let totalStockVal = 0;
            portfolio.forEach(i => {
                const price = mockMarketData[i.sym]?.price || i.buyPrice;
                totalStockVal += price * i.vol * 1000;
            });

            // 2. T√≠nh NAV (V·ªën ch·ªß s·ªü h·ªØu) = T√†i s·∫£n (C·ªï + Ti·ªÅn) - N·ª£
            currentNAV = (totalStockVal + cashBalance) - marginDebt;

            // 3. T√≠nh t·ª∑ l·ªá Margin (Rtt) = T√†i s·∫£n r√≤ng / T·ªïng gi√° tr·ªã danh m·ª•c (theo c√°ch t√≠nh ph·ªï bi·∫øn)
            // Rtt = Equity / (Equity + Debt)
            // Ho·∫∑c an to√†n h∆°n: Rtt = Equity / (StockValue). (N·∫øu vay ti·ªÅn ra r√∫t th√¨ StockValue < Debt + Equity)
            // C√¥ng th·ª©c chu·∫©n CTCK: Rtt = T√†i s·∫£n th·ª±c / T·ªïng t√†i s·∫£n quy ƒë·ªïi.
            // ·ªû ƒë√¢y d√πng c√¥ng th·ª©c ƒë∆°n gi·∫£n ƒë·ªÉ c·∫£nh b√°o: Rtt = NAV / (NAV + Debt)
            const totalAssets = currentNAV + marginDebt;
            let marginRatio = 100;
            if(totalAssets > 0) {
                marginRatio = (currentNAV / totalAssets) * 100;
            }

            // 4. Render UI
            document.getElementById('net-worth-display').innerText = formatNumber(currentNAV) + " VND";
            document.getElementById('total-stock-val').innerText = formatNumber(totalStockVal);
            document.getElementById('cash-display').innerText = formatNumber(cashBalance);
            
            // Render Margin Ratio
            const rttEl = document.getElementById('margin-ratio');
            rttEl.innerText = marginRatio.toFixed(2) + "%";
            rttEl.className = "text-sm font-bold " + (
                marginRatio >= 50 ? "safe-zone" : 
                marginRatio >= 35 ? "warning-zone" : "danger-zone"
            );
        }

        // --- CORE LOGIC: JIT CALCULATOR (FIXED) ---
        function calculateJIT(item) {
            // FIX QUAN TR·ªåNG: T√≠nh r·ªßi ro tr√™n NAV ch·ª© kh√¥ng ph·∫£i tr√™n Ti·ªÅn m·∫∑t
            const nav = currentNAV > 0 ? currentNAV : 0; 
            
            const reward = item.tg - item.ent;
            const risk = item.ent - item.sl;
            const lossPerShare = risk * 1000;
            
            // 1. Kh·ªëi l∆∞·ª£ng theo Quy t·∫Øc 1% NAV (Risk Management)
            const riskAmt = nav * 0.01; 
            let qRisk = 0;
            if(lossPerShare > 0) qRisk = Math.floor((riskAmt / lossPerShare) / 100) * 100;
            
            // 2. Kh·ªëi l∆∞·ª£ng theo S·ª©c mua (Buying Power)
            // Gi·∫£ s·ª≠ Margin 1:1 (S·ª©c mua = NAV * 2) ho·∫∑c User t·ª± qu·∫£n l√Ω.
            // ·ªû ƒë√¢y ta t√≠nh theo "Ti·ªÅn m·∫∑t + Margin 50%" (x2 ti·ªÅn) ƒë·ªÉ g·ª£i √Ω Max
            // Ho·∫∑c ƒë∆°n gi·∫£n: T√≠nh theo NAV (gi·∫£ ƒë·ªãnh d√πng full ti·ªÅn th·ªãt).
            // ƒê·ªÉ an to√†n, khuy·∫øn ngh·ªã theo NAV.
            const qNAV = Math.floor((nav / (item.ent * 1000)) / 100) * 100;

            // L·∫•y s·ªë nh·ªè h∆°n gi·ªØa Risk v√† NAV (Kh√¥ng khuy·∫øn kh√≠ch All-in margin 1 m√£)
            const qSafe = Math.min(qRisk, qNAV);
            
            return { qSafe, totalValue: qSafe * item.ent * 1000 };
        }

        function saveState() {
            localStorage.setItem('jitCash', cashBalance);
            localStorage.setItem('jitDebt', marginDebt);
            localStorage.setItem('jitWatchlist', JSON.stringify(watchlist));
            localStorage.setItem('jitPortfolio', JSON.stringify(portfolio));
            localStorage.setItem('jitHistory', JSON.stringify(history));
            updateDashboard();
            renderWatchlist();
            renderPortfolio();
        }

        // --- ACCOUNT SETUP ---
        function openSetupModal() {
            document.getElementById('setupCash').value = formatNumber(cashBalance);
            document.getElementById('setupDebt').value = formatNumber(marginDebt);
            document.getElementById('setupModal').classList.add('open');
        }
        function saveSetup() {
            cashBalance = parseNumber(document.getElementById('setupCash').value);
            marginDebt = parseNumber(document.getElementById('setupDebt').value);
            saveState();
            closeModal('setupModal');
        }

        // --- IMPORT HOLDING ---
        function openImportModal() { document.getElementById('importModal').classList.add('open'); }
        function executeImport() {
            const sym = document.getElementById('impSym').value.toUpperCase();
            const price = parseFloat(document.getElementById('impPrice').value);
            const vol = parseNumber(document.getElementById('impVol').value);
            if(!sym || !price || !vol) return alert("Nh·∫≠p thi·∫øu th√¥ng tin!");
            
            const newItem = { id: Date.now(), sym, buyPrice: price, vol: vol, buyDate: new Date(), ent: price, tg: price*1.1, sl: price*0.95 };
            portfolio.unshift(newItem);
            saveState();
            closeModal('importModal');
        }

        // --- TRANSACTION LOGIC (LOGIC D√íNG TI·ªÄN CHU·∫®N) ---
        function openTxModal(type, id) {
            const modal = document.getElementById('txModal');
            const title = document.getElementById('modalTitle');
            const btn = document.getElementById('txConfirmBtn');
            const item = type === 'buy' ? watchlist.find(i => i.id === id) : portfolio.find(i => i.id === id);
            
            if(!item) return;
            currentTx = { type, id, item };
            
            const mktPrice = mockMarketData[item.sym]?.price || 0;

            if(type === 'buy') {
                const res = calculateJIT(item);
                document.getElementById('txPrice').value = item.ent;
                // G·ª£i √Ω kh·ªëi l∆∞·ª£ng theo t√≠nh to√°n JIT (1% NAV)
                document.getElementById('txVol').value = formatNumber(res.qSafe); 
                
                title.innerHTML = `<span class="text-sky-400">‚ö° MUA</span> ${item.sym}`;
                btn.className = "w-full mt-6 py-3.5 rounded-lg text-sm font-bold uppercase shadow-lg bg-sky-600 hover:bg-sky-500 text-white";
                btn.onclick = executeBuy;
            } else {
                document.getElementById('txPrice').value = mktPrice || item.buyPrice;
                document.getElementById('txVol').value = formatNumber(item.vol);
                title.innerHTML = `<span class="text-rose-400">üí∞ B√ÅN</span> ${item.sym}`;
                btn.className = "w-full mt-6 py-3.5 rounded-lg text-sm font-bold uppercase shadow-lg bg-rose-600 hover:bg-rose-500 text-white";
                btn.onclick = executeSell;
            }
            modal.classList.add('open');
            updateTxCalc();
        }

        function executeBuy() {
            const price = parseFloat(document.getElementById('txPrice').value);
            const vol = parseNumber(document.getElementById('txVol').value);
            const totalCost = price * vol * 1000;
            
            // LOGIC MUA:
            // 1. D√πng Ti·ªÅn m·∫∑t tr∆∞·ªõc.
            // 2. N·∫øu thi·∫øu ti·ªÅn m·∫∑t -> Vay Margin (TƒÉng Debt).
            
            if (cashBalance >= totalCost) {
                cashBalance -= totalCost;
            } else {
                // Ti·ªÅn m·∫∑t kh√¥ng ƒë·ªß
                const deficit = totalCost - cashBalance;
                cashBalance = 0; // X√†i h·∫øt ti·ªÅn m·∫∑t
                marginDebt += deficit; // Ph·∫ßn thi·∫øu c·ªông v√†o n·ª£
            }

            const newItem = { ...currentTx.item, buyPrice: price, vol: vol, buyDate: new Date() };
            
            // Check g·ªôp m√£ (N·∫øu ƒë√£ c√≥ trong Portfolio th√¨ c·ªông th√™m)
            const existingIdx = portfolio.findIndex(p => p.sym === newItem.sym);
            if(existingIdx !== -1) {
                // T√≠nh gi√° v·ªën trung b√¨nh: (Gi√° c≈© * KL c≈© + Gi√° m·ªõi * KL m·ªõi) / T·ªïng KL
                const oldItem = portfolio[existingIdx];
                const newVol = oldItem.vol + vol;
                const newAvgPrice = ((oldItem.buyPrice * oldItem.vol) + (price * vol)) / newVol;
                
                portfolio[existingIdx].vol = newVol;
                portfolio[existingIdx].buyPrice = parseFloat(newAvgPrice.toFixed(2));
            } else {
                portfolio.unshift(newItem);
            }
            
            // Log History
            logHistory('buy', currentTx.item.sym, price, vol);

            // X√≥a kh·ªèi watchlist (n·∫øu mu·ªën)
            watchlist = watchlist.filter(i => i.id !== currentTx.id);

            saveState(); closeModal('txModal'); switchTab('portfolio');
        }

        function executeSell() {
            const price = parseFloat(document.getElementById('txPrice').value);
            const sellVol = parseNumber(document.getElementById('txVol').value);
            const totalRecieve = price * sellVol * 1000;

            // LOGIC B√ÅN:
            // 1. Ti·ªÅn v·ªÅ ∆∞u ti√™n tr·∫£ N·ª£ Margin tr∆∞·ªõc.
            // 2. D∆∞ m·ªõi c·ªông v√†o Ti·ªÅn m·∫∑t.

            if (marginDebt > 0) {
                if (totalRecieve >= marginDebt) {
                    const surplus = totalRecieve - marginDebt;
                    marginDebt = 0; // Tr·∫£ h·∫øt n·ª£
                    cashBalance += surplus; // C√≤n d∆∞ c·ªông v√†o ti·ªÅn
                } else {
                    marginDebt -= totalRecieve; // Tr·∫£ b·ªõt n·ª£
                    // Ti·ªÅn m·∫∑t v·∫´n gi·ªØ nguy√™n (v√¨ ti·ªÅn b√°n d√πng tr·∫£ n·ª£ h·∫øt)
                }
            } else {
                cashBalance += totalRecieve;
            }

            // Update Portfolio
            const itemIdx = portfolio.findIndex(i => i.id === currentTx.id);
            if(itemIdx !== -1) {
                if(sellVol >= portfolio[itemIdx].vol) {
                    portfolio.splice(itemIdx, 1); // B√°n h·∫øt
                } else {
                    portfolio[itemIdx].vol -= sellVol; // B√°n 1 ph·∫ßn
                }
            }
            
            // Log History
            logHistory('sell', currentTx.item.sym, price, sellVol);

            saveState(); closeModal('txModal'); renderPortfolio();
        }

        function logHistory(type, sym, price, vol) {
            history.unshift({
                type, sym, price, vol,
                date: new Date().toLocaleString('vi-VN')
            });
            if(history.length > 50) history.pop();
            renderHistory();
        }

        // --- HELPER & RENDER ---
        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${t}`).classList.add('active');
            document.getElementById(`tab-${t}`).classList.add('active');
        }
        function addToWatchlist() {
            const sym = document.getElementById('symbol').value.toUpperCase();
            const ent = parseFloat(document.getElementById('entry').value);
            const tg = parseFloat(document.getElementById('target').value);
            const sl = parseFloat(document.getElementById('stoploss').value);
            if(!sym || isNaN(ent)) return;
            watchlist.unshift({ id: Date.now(), sym, ent, tg, sl });
            saveState(); switchTab('watchlist'); simulatePrices();
        }
        function deleteItem(type, id) {
            if(confirm('X√≥a m√£ n√†y?')) {
                if(type === 'w') watchlist = watchlist.filter(i => i.id !== id);
                saveState();
            }
        }
        function clearHistory() {
            if(confirm('X√≥a l·ªãch s·ª≠?')) { history = []; saveState(); }
        }
        function updateTxCalc() {
            const p = parseFloat(document.getElementById('txPrice').value) || 0;
            const v = parseNumber(document.getElementById('txVol').value);
            document.getElementById('txTotalCalc').innerText = formatNumber(p * v * 1000) + " VND";
        }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); currentTx = null; }
        
        function simulatePrices() {
            const allItems = [...watchlist, ...portfolio];
            allItems.forEach(item => {
                const randomChange = (Math.random() * 0.05) - 0.025; 
                const basePrice = item.buyPrice || item.ent;
                const fakePrice = basePrice * (1 + randomChange);
                mockMarketData[item.sym] = { 
                    price: parseFloat(fakePrice.toFixed(2)), 
                    change: (randomChange * 100).toFixed(2),
                    color: fakePrice > basePrice ? 'text-up' : 'text-down' 
                };
            });
            updateDashboard(); renderWatchlist(); renderPortfolio(); renderHistory();
        }

        function renderWatchlist() { 
            const container = document.getElementById('watchlist-container');
            if(watchlist.length === 0) { container.innerHTML = `<div class="text-center text-slate-600 text-[10px] mt-10">Tr·ªëng.</div>`; return; }
            container.innerHTML = watchlist.map(i => {
                const res = calculateJIT(i);
                const mkt = mockMarketData[i.sym] || { price: i.ent, change: 0, color: 'text-white' };
                const isBuyZone = mkt.price > 0 && mkt.price <= i.ent;
                return `<div class="glass-card p-4 rounded-xl border-l-4 ${isBuyZone ? 'border-emerald-500 bg-emerald-900/10' : 'border-slate-600 bg-[#1e293b]'} shadow relative mb-3">
                    <div class="flex justify-between items-start mb-2">
                        <div><span class="font-black text-white text-lg tracking-wide">${i.sym}</span><span class="text-[10px] text-slate-400 block mt-0.5">Entry: <b>${i.ent}</b> | SL: <b class="text-red-400">${i.sl}</b></span></div>
                        <div class="text-right"><div class="text-lg font-bold ${mkt.color}">${mkt.price}</div><div class="text-[10px] ${mkt.change>=0?'text-emerald-400':'text-red-400'}">${mkt.change}%</div></div>
                    </div>
                    ${isBuyZone ? `<div class="mb-2 text-center text-[10px] font-bold text-emerald-400 animate-pulse bg-emerald-900/50 rounded py-1">‚ö° GI√Å V·ªÄ V√ôNG MUA!</div>` : ''}
                    <div class="bg-black/20 rounded p-2 grid grid-cols-2 gap-2 mb-3 border border-slate-700/50">
                        <div><span class="block text-[9px] text-slate-500 uppercase">KL Khuy·∫øn ngh·ªã (1% NAV)</span><span class="font-bold text-yellow-400 text-sm">${formatNumber(res.qSafe)}</span></div>
                        <div class="text-right"><span class="block text-[9px] text-slate-500 uppercase">Gi√° tr·ªã</span><span class="font-bold text-sky-400 text-sm">${formatNumber(res.totalValue)}</span></div>
                    </div>
                    <div class="flex gap-2"><button onclick="openTxModal('buy', ${i.id})" class="flex-1 bg-sky-700 hover:bg-sky-600 text-white text-[10px] font-bold py-2 rounded shadow">‚ö° KH·ªöP MUA</button><button onclick="deleteItem('w', ${i.id})" class="px-3 bg-slate-800 text-slate-400 rounded hover:bg-red-900 text-[10px]">‚úï</button></div>
                </div>`;
            }).join('');
        }
        function renderPortfolio() {
            const container = document.getElementById('portfolio-container');
            if(portfolio.length === 0) { container.innerHTML = `<div class="text-center text-slate-600 text-[10px] mt-10">Tr·ªëng.</div>`; return; }
            container.innerHTML = portfolio.map(i => {
                const mkt = mockMarketData[i.sym] || { price: i.buyPrice, color: 'text-white' };
                const pnl = (mkt.price - i.buyPrice) * i.vol * 1000;
                const pnlPer = ((mkt.price - i.buyPrice)/i.buyPrice)*100;
                return `<div class="glass-card p-4 rounded-xl bg-[#131c31] border-l-4 ${pnl >= 0 ? 'border-emerald-500' : 'border-rose-500'} shadow mb-3">
                    <div class="flex justify-between items-center mb-2"><span class="font-black text-white text-xl">${i.sym}</span><div class="text-right"><span class="text-sm font-bold ${pnl >= 0 ? 'text-emerald-400' : 'text-rose-400'}">${pnl>0?'+':''}${formatNumber(pnl)}</span><span class="block text-[9px] text-slate-500">${pnlPer.toFixed(2)}%</span></div></div>
                    <div class="grid grid-cols-3 gap-2 text-[10px] text-slate-400 bg-black/20 p-2 rounded mb-2 border border-slate-700/50">
                        <div class="text-center">Gi√° V·ªën<br><b class="text-white">${i.buyPrice}</b></div>
                        <div class="text-center border-l border-slate-700">KL<br><b class="text-white">${formatNumber(i.vol)}</b></div>
                        <div class="text-center border-l border-slate-700">Th·ªã tr∆∞·ªùng<br><b class="${mkt.color}">${mkt.price}</b></div>
                    </div>
                    <button onclick="openTxModal('sell', ${i.id})" class="w-full bg-slate-700 hover:bg-slate-600 text-slate-200 text-[10px] font-bold py-2 rounded uppercase">CH·ªêT / C·∫ÆT</button>
                </div>`;
            }).join('');
        }
        function renderHistory() {
            const container = document.getElementById('history-container');
            if(history.length === 0) { container.innerHTML = `<div class="text-center text-slate-600 text-[10px] mt-10">Ch∆∞a c√≥ giao d·ªãch.</div>`; return; }
            container.innerHTML = history.map(h => `<div class="flex justify-between items-center p-3 mb-2 rounded border border-slate-800 bg-slate-900/50 text-[11px]"><div><span class="font-bold ${h.type==='buy'?'text-sky-400':'text-rose-400'}">${h.type==='buy'?'MUA':'B√ÅN'} ${h.sym}</span><div class="text-slate-500 text-[9px]">${h.date}</div></div><div class="text-right"><div><span class="text-slate-400">Gi√°:</span> <span class="text-white font-bold">${h.price}</span></div><div><span class="text-slate-400">KL:</span> <span class="text-white font-bold">${formatNumber(h.vol)}</span></div></div></div>`).join('');
        }
    </script>
